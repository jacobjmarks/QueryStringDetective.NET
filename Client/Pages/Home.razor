@page "/"

@using Shared

<PageTitle>.NET Query String Detective</PageTitle>

<MudStack>
    <MudTextField T="string" spellcheck="false" Class="qs-input" Label="Query string" Placeholder="hello&q=world"
        Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentText="?q=" @bind-Value="CurrentInputValue"
        Immediate="true" TextChanged="InputOnChange" MaxLength="1000">
    </MudTextField>

    <MudStack Row="true" Wrap="Wrap.Wrap" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="pl-2">
        <MudText Typo="Typo.body2">
            Enter a query string above and see how its value is bound to various .NET types
        </MudText>
        <MudSwitch @bind-Value="@showErroneous" Color="Color.Primary">
            Show Erroneous
        </MudSwitch>
    </MudStack>
    <MudTable Items="@bindingResults" Dense="true" Breakpoint="Breakpoint.None" Loading="@isLoading"
        Filter="@(r => showErroneous ? true : !r.AllErroneous)">
        <HeaderContent>
            <MudTh>Parameter Type</MudTh>
            <MudTh>Binding Result</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Parameter Type">
                <MudText Class="mono">@context.Type</MudText>
            </MudTd>
            <MudTd DataLabel="Binding Result" Class="mono">
                @if (context.IsDiscrepant)
                {
                    foreach (var ((apiType, result), i) in context.Results.Select((r, i) => (r, i)))
                    {
                        <MudText Typo="Typo.caption">@apiType.ToDisplayString()</MudText>

                        RenderBindingResult(result);

                        if (i != context.Results.Count - 1)
                        {
                            <MudDivider Class="my-1" />
                        }
                    }
                }
                else
                {
                    var result = context.Results.First().Value;
                    RenderBindingResult(result);
                }

                @{
                    void RenderBindingResult(BindingResult result)
                    {
                        if (result.IsErroneous)
                        {
                            var errorText = result.Error.Message;
                            if (!string.IsNullOrEmpty(result.Error.Detail))
                            {
                                errorText += $": {result.Error.Detail}";
                            }

                            <MudText Color="Color.Error" Class="mono" Typo="Typo.body2">
                                @errorText
                            </MudText>
                        }
                        else
                        {
                            <MudText Class="mono">@result.Result</MudText>
                        }
                    }
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
    @{
        int? erroneousCount = null;
        if (!showErroneous && (erroneousCount = bindingResults.Count(r => r.AllErroneous)) > 0)
        {
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="pl-2">
                <MudText Typo="Typo.body2">
                    @(erroneousCount) other types could not be bound.
                    <MudText Class="d-inline cursor-pointer" Typo="Typo.inherit" Color="Color.Primary"
                        @onclick="() => showErroneous = true">
                        Show them
                    </MudText>
                </MudText>
            </MudStack>
        }
    }
</MudStack>
